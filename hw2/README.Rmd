---
title: 'PM 566 Assignment #2'
author: "Chris Hanson"
date: "10/8/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r libraries, cache = TRUE}
library(tidyverse)
library(tidytext)
library(ggplot2)
library(tibble)
library(dplyr)
library(dtplyr)
library(data.table)
library(leaflet)
```

## Assignment description: 
Data from USC's Children's Health Study will be used to conduct data wrangling and visualization.
There are two data sets: individual and regional. The individual data includes personal and health characteristics of children in 12 communities across Southern California. The regional data includes air quality measurements at the community level.

```{r downloading-datasets}
fn  <- "chs_individual.csv"
fn2 <- "chs_regional.csv"

if (!file.exists(fn))
  download.file("https://raw.githubusercontent.com/USCbiostats/data-science-data/master/01_chs/chs_individual.csv", destfile = fn)

if (!file.exists(fn2))
  download.file("https://raw.githubusercontent.com/USCbiostats/data-science-data/master/01_chs/chs_regional.csv", destfile = fn2)

chs_individual <-  read.csv(fn)
chs_individual <- as_tibble(chs_individual)

chs_regional <-  read.csv(fn2)
chs_regional <- as_tibble(chs_regional)

```

```{r merging-datasets}
#merge the two datasets
chs <- merge(
  x     = chs_individual,      
  y     = chs_regional, 
    # Which obs to keep?
  all.x = TRUE,      
  all.y = FALSE,
  # List of variables to match
  by.x  = "townname",
  by.y  = "townname", 
  )
```

## Data wrangling

1. Making sure there are no duplicates by counting the number of rows:
```{r counting-rows}
count(chs_individual, "townname")
count(chs, "townname")
```

Nothing was duplicated during the merging process.

```{r removing-duplicate-rows, results = FALSE}
chs %>% distinct()
count(chs, "townname")
```

Ensuring that there were no duplicated rows even before the merge.

Imputing data to fill missing values:
```{r missing-data}
chs <- chs %>%
  group_by(male, hispanic) %>%
  mutate_all(funs(ifelse(is.na(.), mean(., na.rm = TRUE),.)))
  #mutate_at(vars(male, hispanic), funs(ifelse(is.na(.), mean(., na.rm = TRUE),.)))
```

Some missing values are supposed to be binary - 0 or 1. We filled NA using mean, which assigned non-integer values to some variables. Let's round these to the nearest integer to clean the data.

```{r}
chs <- chs %>%
  mutate(asthma = round(asthma),
         father_asthma = round(father_asthma),
         mother_asthma = round(mother_asthma),
         wheeze = round(wheeze),
         hayfever = round(hayfever),
         allergy  = round(allergy),
         educ_parent = round(educ_parent),
         smoke = round(smoke),
         pets = round(pets),
         gasstove = round(gasstove))
```


2. Creating variable "obesity_level" and creating a summary table:
```{r categorizing-BMI, eval = FALSE}
chs[, obesity_level := fifelse(
  bmi < 14, "underweight",
    fifelse(bmi < 22, "normal",
      fifelse(bmi < 24, "overweight", "obese"))
)]
```

```{r categorizing-BMI-2}
chs <- chs %>%
  mutate(obesity_level = cut(bmi,
                         breaks = c(-Inf, 14, 22, 24, Inf),
                         labels = c("underweight", "normal", "overweight", "obese")))
```

```{r obesity_level-table}

#knitr::kable(summary(chs$obesity_level))
summary(chs$bmi)
summary(chs$obesity_level)
```



3. Creating variable "smoke_gas_exposure":
```{r categorizing-smoke-gas-exposure}
chs <- chs %>%
  mutate(smoke_gas_exposure = ifelse(smoke == 1 & gasstove == 1, "SG",
                                ifelse(smoke == 0 & gasstove == 1, "G",
                                  ifelse(smoke == 1 & gasstove == 0, "S", "N")
  )))
```

4. Creating summary tables for lung expiratory volume vs variables:
```{r expiration-vs-town}
#average of fev and proportion of asthma by town
chs %>%
  group_by(townname) %>%
  summarise_at(vars(fev, asthma), list(name = mean))
```

```{r expiration-vs-sex}
chs %>%
  group_by(male) %>%
  summarise_at(vars(fev, asthma), list(name = mean))
```

```{r expiration-vs-obesity}
chs %>%
  group_by(obesity_level) %>%
  summarise_at(vars(fev, asthma), list(name = mean))
```

```{r expiration-vs-exposure}
chs %>%
  group_by(smoke_gas_exposure) %>%
  summarise_at(vars(fev, asthma), list(name = mean))
```

## Exploratory data analysis


